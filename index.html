<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Крипто-Космос</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#000 url('https://images.unsplash.com/photo-1451187580459-43490279c0fa?w=512') center/cover;color:#0f0;text-align:center;padding:20px;min-height:100vh}
    h1{margin:15px 0;font-size:1.8em;color:#0ff;text-shadow:0 0 10px #0ff}
    #planet{width:200px;height:200px;margin:20px auto;border-radius:50%;overflow:hidden;box-shadow:0 0 30px #0f0;background:#111}
    #planet img{width:100%;height:100%;object-fit:cover}
    #resources,#shield{font-size:1.4em;margin:10px 0;color:#0f0}
    #clickBtn{font-size:3em;background:#0f0;color:#000;border:none;border-radius:50%;width:100px;height:100px;cursor:pointer;margin:15px}
    #puzzle{display:grid;grid-template-columns:1fr 1fr 1fr;gap:5px;width:150px;margin:20px auto}
    .tile{width:48px;height:48px;background:#333;color:#0f0;font-size:1.2em;display:flex;align-items:center;justify-content:center;cursor:pointer;border:2px solid #0f0}
    .tile.empty{background:#111;border-color:#555}
    #leaderboard{margin:20px 0;color:#ff0;font-size:0.9em}
  </style>
</head>
<body>
  <h1>КРИПТО-КОСМОС</h1>
  <div id="planetNum">Планета #1</div>
  <div id="planet"><img id="planetImg" src="" alt="Планета"></div>
  <div id="resources">TON: 0</div>
  <div id="shield">Защита: 0%</div>
  <button id="clickBtn">⚡</button>
  <div id="puzzle"></div>
  <div id="leaderboard">Лидер: @user — 999 TON</div>

  <script>
    let ton = 0, shield = 0, planetId = 1;
    const planetImg = document.getElementById('planetImg');
    const resources = document.getElementById('resources');
    const shieldEl = document.getElementById('shield');
    const planetNum = document.getElementById('planetNum');
    const clickBtn = document.getElementById('clickBtn');
    const puzzle = document.getElementById('puzzle');

    // === ИИ ГЕНЕРИРУЕТ ПЛАНЕТУ ===
    async function generatePlanet() {
      planetNum.textContent = `Планета #${planetId}`;
      planetImg.src = `https://image.pollinations.ai/prompt/alien%20planet%20with%20AI%20virus%20infection%20${planetId}?width=512&height=512&seed=${Date.now()}`;
      shield = 0;
      shieldEl.textContent = `Защита: ${shield}%`;
    }

    // === КЛИКЕР ===
    clickBtn.onclick = () => {
      ton += 1 + Math.floor(shield / 20);
      resources.textContent = `TON: ${ton}`;
      shield = Math.min(shield + 1, 100);
      shieldEl.textContent = `Защита: ${shield}%`;
      Telegram.WebApp.HapticFeedback.impactOccurred('medium');
      if (shield === 100) {
        alert(`ПЛАНЕТА СПАСЕНА! +${ton} TON`);
        planetId++;
        generatePlanet();
        ton = 0;
        resources.textContent = `TON: ${ton}`;
      }
    };

    // === ПАЗЛ 3x3 ===
    function initPuzzle() {
      puzzle.innerHTML = '';
      let tiles = [1,2,3,4,5,6,7,8,''];
      tiles.sort(() => .5 - Math.random());
      tiles.forEach(t => {
        const tile = document.createElement('div');
        tile.className = 'tile' + (t===''?' empty':'');
        tile.textContent = t;
        tile.onclick = () => moveTile(tile, t);
        puzzle.appendChild(tile);
      });
    }

    function moveTile(tile, num) {
      const empty = document.querySelector('.empty');
      if (!empty) return;
      const i1 = Array.from(puzzle.children).indexOf(tile);
      const i2 = Array.from(puzzle.children).indexOf(empty);
      if (Math.abs(i1 - i2) === 1 || Math.abs(i1 - i2) === 3) {
        empty.textContent = num;
        empty.classList.remove('empty');
        tile.textContent = '';
        tile.classList.add('empty');
        checkWin();
      }
    }

    function checkWin() {
      const tiles = Array.from(puzzle.children).map(t => t.textContent);
      if (tiles.join('') === '12345678') {
        ton += 10;
        resources.textContent = `TON: ${ton}`;
        alert('ПАЗЛ РЕШЁН! +10 TON');
        initPuzzle();
      }
    }

    // === СТАРТ ===
    generatePlanet();
    initPuzzle();

    Telegram.WebApp.ready();
    Telegram.WebApp.expand();
    Telegram.WebApp.MainButton.setText('Поделиться спасением').show().onClick(() => {
      Telegram.WebApp.shareScore?.() || alert(`Я спас ${planetId} планет! TON: ${ton}`);
    });
  </script>
</body>
</html>